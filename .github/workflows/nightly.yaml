name: Nightly checks

on:
  # workflow_dispatch so that it can be triggered manually if needed
  workflow_dispatch:
  schedule:
    - cron: "34 23 * * *"

jobs:
  e2e-tests:
    name: 'E2E Tests (${{ matrix.k8s_version }}) - ${{ matrix.branch }}'
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        branch: [ main, 1.2.x, 1.1.x ]
        experimental: [ false ]
        k8s_version:
          # See https://access.redhat.com/solutions/4870701 for the mapping between OpenShift 4.x and Kubernetes versions.
          # Per https://access.redhat.com/support/policy/updates/developerhub, we want support for OCP 4.12+, so K8s v1.25+
          - v1.25.16 # OCP 4.12
          - v1.26.15 # OCP 4.13
          - v1.27.15 # OCP 4.14
          - v1.28.11 # OCP 4.15
        include:
          # These are upcoming versions that we don't explicitly claim support for but still want to test against.
          # Marked as experimental so as not to fail the build, but we still want to capture any useful information in advance in case of failures.
          - k8s_version: v1.29.6 # OCP 4.16 (not claimed as supported yet)
            branch: main
            experimental: true
          - k8s_version: latest
            branch: main
            experimental: true
          - k8s_version: v1.29.6 # OCP 4.16 (not claimed as supported yet)
            branch: 1.2.x
            experimental: true
          - k8s_version: latest
            branch: 1.2.x
            experimental: true
          - k8s_version: v1.29.6 # OCP 4.16 (not claimed as supported yet)
            branch: 1.1.x
            experimental: true
          - k8s_version: latest
            branch: 1.1.x
            experimental: true
        exclude:
          # These are the combinations not supported at all and should be excluded
          - branch: 1.2.x
            k8s_version: v1.25.16 # OCP v4.12 not supported in 1.2
          - branch: main
            k8s_version: v1.25.16 # OCP 4.12 not supported in 1.3+
    concurrency:
      group: '${{ github.workflow }}-${{ matrix.branch }}-${{ matrix.k8s_version }}'
      cancel-in-progress: true
    env:
      CONTAINER_ENGINE: podman
    steps:
      - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4 # default branch will be checked out by default on scheduled workflows
        with:
          fetch-depth: 0

      - if: ${{ matrix.branch != 'main' }}
        name: Checkout ${{ matrix.branch }} branch
        run: git switch ${{ matrix.branch }}

      - name: Setup Go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5
        with:
          go-version-file: 'go.mod'

      - name: Determine built operator image
        run: |
          echo "OPERATOR_IMAGE=$(make show-img)" >> $GITHUB_ENV

      - name: Check if image exists in remote registry
        id: operator-image-existence-checker
        run: |
          echo "OPERATOR_IMAGE_EXISTS=$(if skopeo inspect "docker://${{ env.OPERATOR_IMAGE }}" > /dev/null; then echo "true"; else echo "false"; fi)" >> $GITHUB_OUTPUT

      - name: Display warning if image was not found
        if: ${{ steps.operator-image-existence-checker.outputs.OPERATOR_IMAGE_EXISTS == 'false' }}
        run: |
          echo "::warning ::Image ${{ env.OPERATOR_IMAGE }} not found for testing the ${{ matrix.branch }} branch. It might have expired. E2E tests will be skipped for ${{ matrix.branch }}."

      - name: Start Minikube
        if: ${{ steps.operator-image-existence-checker.outputs.OPERATOR_IMAGE_EXISTS == 'true' }}
        uses: medyagh/setup-minikube@d8c0eb871f6f455542491d86a574477bd3894533 # v0.0.18
        with:
          addons: ingress
          kubernetes-version: ${{ matrix.k8s_version }}

      - name: Run E2E tests (Operator Upgrade path)
        # Testing upgrade from 1.1.x
        if: ${{ matrix.branch != '1.1.x' && steps.operator-image-existence-checker.outputs.OPERATOR_IMAGE_EXISTS == 'true' }}
        env:
          BACKSTAGE_OPERATOR_TESTS_PLATFORM: minikube
          IMG: ${{ env.OPERATOR_IMAGE }}
        run: make test-e2e-upgrade

      - name: Run E2E tests
        if: ${{ steps.operator-image-existence-checker.outputs.OPERATOR_IMAGE_EXISTS == 'true' }}
        env:
          BACKSTAGE_OPERATOR_TESTS_PLATFORM: minikube
          IMG: ${{ env.OPERATOR_IMAGE }}
        run: make test-e2e
